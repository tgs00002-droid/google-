import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import numpy as np

# ==========================================
# 1. Configuration & Style
# ==========================================
st.set_page_config(
    page_title="Strategic Financial Intelligence",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for a professional "Google-like" look
st.markdown("""
    <style>
    .metric-card {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #4285F4;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    .metric-label { font-size: 14px; color: #5f6368; }
    .metric-value { font-size: 24px; font-weight: bold; color: #202124; }
    .highlight { color: #4285F4; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# 2. Data Engine (The "Brain")
# ==========================================
class FinancialEngine:
    """
    Handles all ETL (Extract, Transform, Load) and metric engineering.
    Decoupling logic from presentation makes this scalable and testable.
    """
    def __init__(self, file_path):
        self.raw_data = pd.read_csv(file_path)
        self.df = self._process_data()

    def _process_data(self):
        df = self.raw_data.copy()
        df = df.sort_values('year')
        
        # --- Feature Engineering ---
        # 1. Rule of 40 (Growth + Margin)
        # Note: Depending on your CSV, if data is 0.25 for 25%, multiply by 100.
        # If data is already 25, keep as is. Logic below assumes decimals based on snippets.
        df['rule_of_40'] = (df['revenue_yoy'] * 100) + (df['operating_margin'] * 100)
        
        # 2. Operating Leverage (Op Income Growth / Revenue Growth)
        # Calculate Op Income Growth first if not present
        df['op_income_yoy'] = df['operating_income'].pct_change()
        df['operating_leverage'] = df['op_income_yoy'] / df['revenue_yoy']
        
        # 3. Clean large numbers for display
        df['revenue_B'] = df['revenue'] / 1e9
        df['op_income_B'] = df['operating_income'] / 1e9
        
        return df

    def get_latest_metrics(self):
        latest = self.df.iloc[-1]
        prev = self.df.iloc[-2]
        return {
            'year': int(latest['year']),
            'revenue': latest['revenue_B'],
            'rev_growth': latest['revenue_yoy'],
            'margin': latest['operating_margin'],
            'rule_40': latest['rule_of_40'],
            'delta_rev': (latest['revenue'] - prev['revenue']) / 1e9
        }

    def generate_forecast(self, base_growth, bull_adj, bear_adj, years=3):
        """Generates 3 scenarios: Base, Bull, and Bear case."""
        last_year = self.df['year'].max()
        last_rev = self.df['revenue'].iloc[-1]
        
        scenarios = []
        for year_idx in range(1, years + 1):
            curr_year = last_year + year_idx
            
            # Base Case
            base_rev = last_rev * ((1 + base_growth) ** year_idx)
            scenarios.append({'Year': curr_year, 'Revenue': base_rev / 1e9, 'Scenario': 'Base Case'})
            
            # Bull Case
            bull_rev = last_rev * ((1 + base_growth + bull_adj) ** year_idx)
            scenarios.append({'Year': curr_year, 'Revenue': bull_rev / 1e9, 'Scenario': 'Bull Case'})
            
            # Bear Case
            bear_rev = last_rev * ((1 + base_growth - bear_adj) ** year_idx)
            scenarios.append({'Year': curr_year, 'Revenue': bear_rev / 1e9, 'Scenario': 'Bear Case'})
            
        return pd.DataFrame(scenarios)

# ==========================================
# 3. Visualization Class
# ==========================================
class ChartBuilder:
    """
    Dedicated class for generating Plotly charts.
    Ensures consistent styling across the app.
    """
    @staticmethod
    def plot_divergence(df):
        fig = go.Figure()
        
        # Revenue Line
        fig.add_trace(go.Scatter(
            x=df['year'], y=df['revenue_index'],
            name='Fundamental Growth (Revenue)',
            mode='lines+markers',
            line=dict(color='#4285F4', width=3)
        ))
        
        # Stock Line
        fig.add_trace(go.Scatter(
            x=df['year'], y=df['stock_index'],
            name='Market Valuation (Stock Price)',
            mode='lines+markers',
            line=dict(color='#34A853', width=3, dash='dot')
        ))
        
        fig.update_layout(
            title="Valuation Reality Check: Fundamentals vs. Hype",
            xaxis_title="Year",
            yaxis_title="Index (Base=100)",
            template="plotly_white",
            height=400,
            legend=dict(yanchor="top", y=0.99, xanchor="left", x=0.01, bgcolor="rgba(255,255,255,0.8)")
        )
        return fig

    @staticmethod
    def plot_rule_of_40(df):
        # Filter out NaN/Inf for clean plotting
        clean_df = df.dropna(subset=['revenue_yoy', 'operating_margin', 'revenue_B'])
        
        fig = px.scatter(
            clean_df, x='revenue_yoy', y='operating_margin',
            size='revenue_B', color='year',
            title="The 'Rule of 40' Trade-off: Growth vs. Profitability",
            labels={'revenue_yoy': 'Revenue Growth', 'operating_margin': 'Operating Margin'},
            template="plotly_white",
            color_continuous_scale=px.colors.sequential.Bluered,
            height=400
        )
        
        # Add the 'Rule of 40' threshold line (x + y = 0.40)
        x_range = np.linspace(clean_df['revenue_yoy'].min(), clean_df['revenue_yoy'].max(), 100)
        y_range = 0.40 - x_range
        
        fig.add_trace(go.Scatter(
            x=x_range, y=y_range, mode='lines', 
            name='Rule of 40 Threshold',
            line=dict(color='gray', dash='dash')
        ))
        
        return fig

    @staticmethod
    def plot_forecast(hist_df, pred_df):
        fig = go.Figure()
        
        # Historical Data
        fig.add_trace(go.Scatter(
            x=hist_df['year'], y=hist_df['revenue_B'],
            name='Historical Revenue',
            line=dict(color='#202124', width=3)
        ))
        
        # Forecast Scenarios
        colors = {'Base Case': '#4285F4', 'Bull Case': '#34A853', 'Bear Case': '#EA4335'}
        
        for scenario in pred_df['Scenario'].unique():
            subset = pred_df[pred_df['Scenario'] == scenario]
            fig.add_trace(go.Scatter(
                x=subset['Year'], y=subset['Revenue'],
                name=scenario,
                line=dict(color=colors[scenario], width=2, dash='dash' if scenario != 'Base Case' else 'solid')
            ))
            
        fig.update_layout(
            title="Forward-Looking Scenarios (Driver-Based)",
            yaxis_title="Revenue ($ Billions)",
            xaxis_title="Year",
            template="plotly_white",
            height=400
        )
        return fig

# ==========================================
# 4. Main App Logic
# ==========================================
def main():
    # Load Data
    try:
        engine = FinancialEngine('master.csv')
    except Exception as e:
        st.error(f"Error loading data: {e}. Please ensure 'master.csv' is in the directory.")
        return

    # Sidebar: Controls
    st.sidebar.title("ðŸŽ® Analyst Controls")
    
    st.sidebar.markdown("### Forecast Assumptions")
    growth_input = st.sidebar.slider("Base Revenue Growth Rate", 0.0, 0.30, 0.12, 0.01, format="%.2f")
    
    st.sidebar.markdown("### Macro Factors")
    macro_impact = st.sidebar.selectbox("Economic Outlook", ["Neutral", "Recessionary (-5%)", "Expansionary (+5%)"])
    
    # Dynamic Scenario Logic
    bull_adj = 0.05
    bear_adj = 0.05
    
    # Adjust base growth based on macro toggle
    if macro_impact == "Recessionary (-5%)":
        growth_input = max(0.0, growth_input - 0.05)
    elif macro_impact == "Expansionary (+5%)":
        growth_input += 0.05
        
    st.sidebar.info(f"Active Growth Driver: **{growth_input:.1%}**")

    # --- HEADER SECTION ---
    st.title("ðŸ“Š Strategic Financial Intelligence Dashboard")
    st.markdown("""
    This dashboard provides a centralized view of firm fundamentals, market valuation, 
    and forward-looking scenarios to support capital allocation decisions.
    """)
    st.markdown("---")
    
    # Top Level Metrics
    metrics = engine.get_latest_metrics()
    
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("FY Revenue", f"${metrics['revenue']:.1f}B", f"{metrics['rev_growth']:.1%}")
    col2.metric("Op Margin", f"{metrics['margin']:.1%}", "Stable")
    col3.metric("Rule of 40 Score", f"{metrics['rule_40']:.0f}", "Target > 40")
    col4.metric("Market Beta", "1.05", "Neutral")

    # --- SECTION 1: HISTORICAL ANALYSIS ---
    st.markdown("### 1. Historical Performance & Valuation")
    
    c1, c2 = st.columns([2, 1])
    
    with c1:
        # Chart: Divergence
        fig_div = ChartBuilder.plot_divergence(engine.df)
        st.plotly_chart(fig_div, use_container_width=True)
    
    with c2:
        st.markdown(f"""
        <div class="metric-card">
        <b>ðŸ’¡ Analyst Insight: Valuation Decoupling</b><br><br>
        We observe a divergence between <span class="highlight">Revenue Growth</span> (Fundamentals) 
        and <span class="highlight">Stock Price</span> (Sentiment).<br><br>
        While revenue grew at a steady CAGR, stock volatility was driven largely by 
        multiple expansion rather than earnings surprises.
        </div>
        """, unsafe_allow_html=True)

    # --- SECTION 2: EFFICIENCY ---
    st.markdown("### 2. The Efficiency Frontier")
    
    c3, c4 = st.columns([1, 2])
    
    with c3:
        st.markdown(f"""
        <div class="metric-card">
        <b>The "Rule of 40" Trade-off</b><br><br>
        This chart plots <b>Growth vs. Margin</b>.<br>
        <ul>
        <li><b>Top Right:</b> High Growth, High Profit (Unicorns)</li>
        <li><b>Bottom Left:</b> Warning Zone</li>
        </ul>
        <br>
        <b>Insight:</b> The company is maturing, moving from the top-right towards a stable, 
        cash-cow position (lower right).
        </div>
        """, unsafe_allow_html=True)
        
    with c4:
        fig_rule40 = ChartBuilder.plot_rule_of_40(engine.df)
        st.plotly_chart(fig_rule40, use_container_width=True)

    # --- SECTION 3: FORECASTING ---
    st.markdown("### 3. Forward-Looking Scenarios")
    
    # Generate Data
    forecast_df = engine.generate_forecast(
        base_growth=growth_input, 
        bull_adj=bull_adj, 
        bear_adj=bear_adj
    )
    
    c5, c6 = st.columns([2, 1])
    
    with c5:
        fig_forecast = ChartBuilder.plot_forecast(engine.df, forecast_df)
        st.plotly_chart(fig_forecast, use_container_width=True)
        
    with c6:
        st.markdown("""
        <div class="metric-card">
        <b>Scenario Logic</b><br><br>
        <b>Base Case:</b> Assumes steady-state search volume and ad pricing.<br>
        <b>Bull Case (+5%):</b> Driven by AI-monetization upside and macro recovery.<br>
        <b>Bear Case (-5%):</b> Driven by regulatory headwinds or margin compression.
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("View Forecast Data"):
            st.dataframe(forecast_df.set_index('Year'))

if __name__ == "__main__":
    main()
