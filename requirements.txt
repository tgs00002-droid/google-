import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import numpy as np
import os

# ==========================================
# 1. APP CONFIGURATION & STYLING
# ==========================================
st.set_page_config(
    page_title="Strategic Financial Intelligence",
    layout="wide",
    initial_sidebar_state="expanded",
    page_icon="üìà"
)

# Custom CSS for a clean, professional "Google-Style" aesthetic
st.markdown("""
    <style>
    /* Main container styling */
    .main { background-color: #ffffff; }
    
    /* Card styling for metrics and insights */
    .metric-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 5px solid #4285F4; /* Google Blue */
        box-shadow: 0px 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        font-family: 'Roboto', sans-serif;
    }
    
    /* Typography */
    h1, h2, h3 { color: #202124; font-family: 'Google Sans', sans-serif; }
    .highlight { color: #4285F4; font-weight: bold; }
    .metric-label { font-size: 14px; color: #5f6368; }
    .metric-value { font-size: 28px; font-weight: 700; color: #202124; }
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# 2. DATA ARCHITECTURE (The Logic Layer)
# ==========================================
class FinancialEngine:
    """
    Acts as the 'Single Source of Truth'. 
    Handles data loading, cleaning, and advanced metric calculation.
    """
    def __init__(self, file_path):
        self.file_path = file_path
        self.raw_data = None
        self.df = None
        self._load_data()

    def _load_data(self):
        if not os.path.exists(self.file_path):
            st.error(f"‚ö†Ô∏è Error: '{self.file_path}' not found. Please ensure the CSV is in the same folder.")
            st.stop()
        self.raw_data = pd.read_csv(self.file_path)
        self._process_data()

    def _process_data(self):
        """Feature Engineering for advanced insights."""
        df = self.raw_data.copy()
        df = df.sort_values('year')
        
        # --- Metric 1: The Rule of 40 (Growth + Margin) ---
        # Logic: (Revenue Growth % * 100) + (Operating Margin % * 100)
        # We assume input data is decimal (e.g., 0.25). We convert to integer score (e.g., 25).
        df['rule_of_40'] = (df['revenue_yoy'] * 100) + (df['operating_margin'] * 100)
        
        # --- Metric 2: Operating Leverage ---
        # Logic: Are profits growing faster than revenue?
        df['op_income_yoy'] = df['operating_income'].pct_change()
        df['operating_leverage'] = df['op_income_yoy'] / df['revenue_yoy']
        
        # --- Formatting: Billions for readability ---
        df['revenue_B'] = df['revenue'] / 1e9
        
        self.df = df

    def get_kpis(self):
        """Returns the most recent year's key performance indicators."""
        latest = self.df.iloc[-1]
        prev = self.df.iloc[-2]
        
        return {
            'year': int(latest['year']),
            'revenue': latest['revenue_B'],
            'growth': latest['revenue_yoy'],
            'margin': latest['operating_margin'],
            'rule_40': latest['rule_of_40'],
            'beta': 1.05 # Placeholder: In a real app, calculate relative to SP500
        }

    def generate_forecast(self, base_growth, bull_adj, bear_adj, years=3):
        """
        Creates a DataFrame containing 3 scenario paths (Base, Bull, Bear).
        Uses Driver-Based Modeling.
        """
        last_year = self.df['year'].max()
        last_rev = self.df['revenue'].iloc[-1]
        
        scenarios = []
        for i in range(1, years + 1):
            curr_year = last_year + i
            
            # Scenario Calculations
            # 1. Base Case: User defined input
            base_rev = last_rev * ((1 + base_growth) ** i)
            scenarios.append({'Year': curr_year, 'Revenue': base_rev/1e9, 'Scenario': 'Base Case'})
            
            # 2. Bull Case: Optimistic Macro (+ adjustment)
            bull_rev = last_rev * ((1 + base_growth + bull_adj) ** i)
            scenarios.append({'Year': curr_year, 'Revenue': bull_rev/1e9, 'Scenario': 'Bull Case'})
            
            # 3. Bear Case: Pessimistic Macro (- adjustment)
            bear_rev = last_rev * ((1 + base_growth - bear_adj) ** i)
            scenarios.append({'Year': curr_year, 'Revenue': bear_rev/1e9, 'Scenario': 'Bear Case'})
            
        return pd.DataFrame(scenarios)

# ==========================================
# 3. VISUALIZATION ENGINE (The Presentation Layer)
# ==========================================
class ChartBuilder:
    """
    Dedicated class for professional Plotly charts.
    Ensures consistent brand colors (Google Blue/Green/Red).
    """
    COLOR_BLUE = '#4285F4'
    COLOR_GREEN = '#34A853'
    COLOR_RED = '#EA4335'
    COLOR_GRAY = '#B0B0B0'

    @staticmethod
    def plot_divergence(df):
        """Compares Fundamental Growth vs. Market Valuation."""
        fig = go.Figure()
        
        # Fundamentals (Revenue)
        fig.add_trace(go.Scatter(
            x=df['year'], y=df['revenue_index'],
            name='Revenue Index (Fundamentals)',
            mode='lines+markers',
            line=dict(color=ChartBuilder.COLOR_BLUE, width=3)
        ))
        
        # Sentiment (Stock Price)
        fig.add_trace(go.Scatter(
            x=df['year'], y=df['stock_index'],
            name='Stock Price Index (Market)',
            mode='lines+markers',
            line=dict(color=ChartBuilder.COLOR_GREEN, width=3, dash='dot')
        ))
        
        fig.update_layout(
            title="<b>Valuation Reality Check:</b> Fundamentals vs. Sentiment",
            xaxis_title="Fiscal Year",
            yaxis_title="Index (Base=100)",
            template="plotly_white",
            height=400,
            hovermode="x unified",
            legend=dict(yanchor="top", y=0.99, xanchor="left", x=0.01)
        )
        return fig

    @staticmethod
    def plot_rule_of_40(df):
        """Scatter plot for Growth vs. Profitability."""
        # Filter for clean data
        clean_df = df.dropna(subset=['revenue_yoy', 'operating_margin'])
        
        fig = px.scatter(
            clean_df, x='revenue_yoy', y='operating_margin',
            size='revenue_B', color='year',
            title="<b>Efficiency Frontier:</b> The Rule of 40",
            labels={'revenue_yoy': 'Revenue Growth (%)', 'operating_margin': 'Operating Margin (%)'},
            template="plotly_white",
            color_continuous_scale=px.colors.sequential.Blues,
            height=400
        )
        
        # Add Reference Line (The "40%" threshold)
        # Equation: y = 0.40 - x
        x_line = np.linspace(clean_df['revenue_yoy'].min(), clean_df['revenue_yoy'].max(), 100)
        y_line = 0.40 - x_line
        
        fig.add_trace(go.Scatter(
            x=x_line, y=y_line, mode='lines', name='Rule of 40 Target',
            line=dict(color=ChartBuilder.COLOR_GRAY, dash='dash')
        ))
        
        return fig

    @staticmethod
    def plot_forecast(hist_df, forecast_df):
        """Connects historical actuals with future scenarios."""
        fig = go.Figure()
        
        # Historicals
        fig.add_trace(go.Scatter(
            x=hist_df['year'], y=hist_df['revenue_B'],
            name='Actuals',
            line=dict(color='#202124', width=4)
        ))
        
        # Scenarios
        colors = {'Base Case': ChartBuilder.COLOR_BLUE, 
                  'Bull Case': ChartBuilder.COLOR_GREEN, 
                  'Bear Case': ChartBuilder.COLOR_RED}
        
        for scenario in forecast_df['Scenario'].unique():
            subset = forecast_df[forecast_df['Scenario'] == scenario]
            fig.add_trace(go.Scatter(
                x=subset['Year'], y=subset['Revenue'],
                name=scenario,
                line=dict(color=colors[scenario], width=2, dash='dash')
            ))
            
        fig.update_layout(
            title="<b>Forward Guidance:</b> 3-Year Revenue Scenarios",
            yaxis_title="Revenue ($ Billions)",
            xaxis_title="Year",
            template="plotly_white",
            height=450,
            hovermode="x unified"
        )
        return fig

# ==========================================
# 4. MAIN APPLICATION
# ==========================================
def main():
    # --- Sidebar Controls ---
    st.sidebar.header("üéõÔ∏è Analyst Controls")
    st.sidebar.write("Adjust assumptions to update the forecast model.")
    
    # 1. Growth Driver
    base_growth = st.sidebar.slider(
        "Base Revenue Growth (%)", 
        min_value=0.0, max_value=0.30, value=0.12, step=0.01, format="%.2f"
    )
    
    # 2. Macro Driver
    macro_outlook = st.sidebar.selectbox(
        "Macro Economic Outlook", 
        ["Neutral", "Recessionary (-500bps)", "Expansionary (+500bps)"]
    )
    
    # Logic to adjust model based on macro selection
    bull_adj = 0.05
    bear_adj = 0.05
    if macro_outlook == "Recessionary (-500bps)":
        base_growth = max(0.0, base_growth - 0.05)
        st.sidebar.warning("üìâ Adjusting Base Case down for recessionary environment.")
    elif macro_outlook == "Expansionary (+500bps)":
        base_growth += 0.05
        st.sidebar.success("üìà Adjusting Base Case up for expansionary environment.")

    # --- Load Data ---
    engine = FinancialEngine('master.csv')
    kpis = engine.get_kpis()

    # --- Dashboard Header ---
    st.title("üìä Strategic Financial Command Center")
    st.markdown("Real-time view of firm fundamentals, market valuation, and strategic scenarios.")
    st.markdown("---")

    # --- Top Level Metrics ---
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("FY Revenue", f"${kpis['revenue']:.1f}B", f"{kpis['growth']:.1%}")
    c2.metric("Op Margin", f"{kpis['margin']:.1%}", "Stable")
    c3.metric("Rule of 40 Score", f"{kpis['rule_40']:.0f}", "Target > 40")
    c4.metric("Implied Beta", f"{kpis['beta']}", "Neutral")

    st.markdown("---")

    # --- Section 1: Valuation Analysis ---
    st.subheader("1. Valuation Reality Check")
    col_viz1, col_txt1 = st.columns([2, 1])
    
    with col_viz1:
        fig1 = ChartBuilder.plot_divergence(engine.df)
        st.plotly_chart(fig1, use_container_width=True)
    
    with col_txt1:
        st.markdown("""
        <div class="metric-card">
        <b>üí° Analyst Note:</b><br><br>
        We observe a distinct divergence between 
        <span class="highlight">Fundamental Growth</span> and 
        <span class="highlight">Market Price</span>.<br><br>
        While revenue has compounded steadily, stock price volatility 
        suggests valuation is being driven by external multiple expansion 
        rather than internal performance surprises.
        </div>
        """, unsafe_allow_html=True)

    # --- Section 2: Efficiency Analysis ---
    st.subheader("2. The Efficiency Frontier (Rule of 40)")
    col_txt2, col_viz2 = st.columns([1, 2])
    
    with col_txt2:
        st.markdown("""
        <div class="metric-card">
        <b>Strategy Insight:</b><br><br>
        The "Rule of 40" states that Growth Rate + Profit Margin should exceed 40.<br><br>
        <b>Current Status:</b> The company is transitioning from a 
        "Growth at all costs" phase (Top Right) to a mature "Cash Cow" 
        phase (Lower Right).
        </div>
        """, unsafe_allow_html=True)
        
    with col_viz2:
        fig2 = ChartBuilder.plot_rule_of_40(engine.df)
        st.plotly_chart(fig2, use_container_width=True)

    # --- Section 3: Scenario Planning ---
    st.subheader("3. Strategic Forecast Model")
    
    # Run Forecast Logic
    forecast_df = engine.generate_forecast(base_growth, bull_adj, bear_adj)
    
    col_viz3, col_txt3 = st.columns([2, 1])
    
    with col_viz3:
        fig3 = ChartBuilder.plot_forecast(engine.df, forecast_df)
        st.plotly_chart(fig3, use_container_width=True)
        
    with col_txt3:
        st.markdown(f"""
        <div class="metric-card">
        <b>Model Assumptions:</b><br>
        <ul>
        <li><b>Base Case ({base_growth:.1%}):</b> Consensus estimates.</li>
        <li><b>Bull Case:</b> AI monetization success + macro tailwinds.</li>
        <li><b>Bear Case:</b> Regulatory pressure + margin compression.</li>
        </ul>
        </div>
        """, unsafe_allow_html=True)
        
        # Download Button (Product Feature)
        csv = forecast_df.to_csv(index=False).encode('utf-8')
        st.download_button(
            "üì• Download Scenario Data",
            data=csv,
            file_name="forecast_scenarios.csv",
            mime="text/csv"
        )

if __name__ == "__main__":
    main()
